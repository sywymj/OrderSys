@{
    Layout = null;
}

<div class="mini-splitter" style="width:100%;height:100%;">
    <div size="240" showcollapsebutton="true">
        <div class="mini-fit">
            <ul id="ScopeType-datagrid" class="mini-grid" style="width: 100%; height: 100%;" ajaxoptions="{type : 'get'}" autoload="false"
                showtreeicon="true" textfield="Title" idfield="ID"></ul>
        </div>
    </div>
    <div showcollapsebutton="true">
        <div class="mini-fit">
            <div id="ResourceID" class="mini-hidden"></div>
            <div id="Target" class="mini-hidden"></div>
            <div id="Scope-datagrid" class="mini-datagrid" style="width:100%;height:100%;" borderstyle="border:0;" ajaxoptions="{type : 'get'}" autoload="false"
                 url="@Url.Action("GetGrantScopeList", "Permission", new { area = "Admin" })" idfield="ID" datafield="Data.DT.JSNet" totalfield="Data.Count"
                 multiselect="true">
                <div property="columns">
                    @*<div type="checkcolumn"></div>*@
                    <div type="indexcolumn" headeralign="center">序号</div>
                    <div field="Title" width="120" headeralign="center" allowsort="true" visible="false">名称</div>
                    <div field="Organize_FullName" width="120" headeralign="center" allowsort="true" visible="false">所属机构</div>
                    <div field="Organize_Code" width="120" headeralign="center" allowsort="true" visible="false">机构代码</div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="mini-toolbar" style="text-align:center;padding-top:8px;padding-bottom:8px;" borderstyle="border:0;">
    <a class="mini-button" style="width:60px;" onclick="onOk()">确定</a>
    <span style="display:inline-block;width:25px;"></span>
    <a class="mini-button" style="width:60px;" onclick="onCancel()">取消</a>
</div>


<script type="text/javascript">
    mini.parse();

    var Target_grid = mini.get("Target-datagrid");
    var Scope_grid = mini.get("Scope-datagrid");

    ////////////////////
    //标准方法接口定义
    function SetGridData(data) {
        //跨页面传递的数据对象，克隆后才可以安全使用
        data = mini.clone(data);
        var resourceID = data.ID;
        var target = data.Target;
        mini.get("ResourceID").setValue(resourceID);
        mini.get("Target").setValue(target);
        
        //选中左侧栏目
        if (target == "") {
            return false;
        } else {
            LoadLeft(target);
        }

        //加载grid数据
        Scope_grid.load({
            ResourceID: resourceID,
            Target: target
        }, function (re) {
            var jdata = ajaxTips(re.text);
            if (jdata.Code == "200") {
                //选中已配置的资源对象
                var url = '@Url.Action("GetGrantedScopeIDs", "Permission", new { area = "Admin" })';
                var parms = {
                    ResourceID: resourceID
                };
                debugger;
                doGetSync(url, parms, function (jdata) {
                    if (jdata.Code == "200") {
                        Scope_grid.setValue(jdata.Data);
                    }
                })
            }
        }, function (re) {
        })
    }


    Target_grid.on("select", function (e) {
        var ResourceID = mini.get("ResourceID").getValue();
        if (e.isLeaf) {
            mini.get("Target").setValue(e.node.ID);
            Scope_grid.load({
                ResourceID: ResourceID,
                Target: e.node.ID,
            });
        } else {
            Scope_grid.setData([]);
            Scope_grid.setTotalCount(0);
        }
    });

    //////////////////////////////////
    function LoadLeft(target) {
        var data = [{ ID: 'VR_RoleOrganize', Title: '角色' }, { ID: 'VOrg_Organize', Title: '组织机构' }];
        Target_grid.data = data;
        Target_grid.load();

        var row = findRow(function (row) {
            if (row.ID == target) return true;
        })

        if (row) {
            Target_grid.select(row);
        }
    }


    function CloseWindow(action) {
        if (window.CloseOwnerWindow) return window.CloseOwnerWindow(action);
        else window.close();
    }

    function onOk() {
        var ResourceID = mini.get("ResourceID").getValue();
        var Target = mini.get("Target").getValue();

        var rows = staff_grid.getSelecteds();
        var ids = [];
        for (var i = 0, l = rows.length; i < l; i++) {
            var row = rows[i];
            ids.push(row.Organize_ID);
        }
        TargetIDs = ids.join(",");

        var url = "@Url.Action("GrantScope", "Permission", new { area = "Admin" })";
        var data = {
            ResourceID: ResourceID,
            Target: Target,
            TargetIDs: TargetIDs
        };
        doGetSync(url, data, function (jdata) {
            if (jdata.Code == "200") {
                CloseWindow("save");
            }
        });
    }
    function onCancel() {
        CloseWindow("cancel");
    }
</script>

