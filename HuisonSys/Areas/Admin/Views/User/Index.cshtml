@{
    ViewBag.Title = "员工管理";
    Layout = "~/Areas/Admin/Views/Shared/_InnerLayout.cshtml";
}
<script src="~/Areas/Admin/Script/ajaxfileupload.js"></script>

@Html.Partial("~/Areas/Admin/Views/Shared/_Header.cshtml", Request.Url.AbsolutePath)
<div class="mini-fit">
    <div id="staff-datagrid" class="mini-datagrid" idfield="User_ID" ajaxoptions="{type : 'get'}" style="width:100%;height:100%"
         url="@Url.Action("GetListByPage", "User", new { area = "Admin" })" datafield="Data.DT.JSNet" totalfield="Data.Count" multiselect="true">
        <div property="columns">
            <div type="checkcolumn"></div>
            <div type="indexcolumn" headeralign="center">序号</div>
            <div field="Staff_ID" width="120" headeralign="center" allowsort="true" visible="false">Staff_ID</div>
            <div field="Organize_ID" width="120" headeralign="center" allowsort="true" visible="false">Organize_ID</div>
            <div field="User_ID" width="120" headeralign="center" align="center" allowsort="true" visible="false">User_ID</div>
            <div field="Staff_Name" width="60" headeralign="center" align="center" allowsort="true">姓名</div>
            <div field="User_UserName" width="60" headeralign="center" align="center" allowsort="true">用户名</div>
            <div field="User_AddedVXUser" width="30" headeralign="center" align="center" allowsort="true" renderer="onAddedVXUserRenderer">微信用户</div>
            <div field="Staff_Tel" width="60" headeralign="center" align="center" allowsort="true">电话</div>
            <div field="Organize_FullName" width="120" headeralign="center" align="center" allowsort="true">部门</div>
            <div field="Role_FullNames" width="240" headeralign="center" align="center" allowsort="true">已分配的角色</div>
        </div>
    </div>
</div>


<div id="import-window" class="mini-window" title="批量导入" style="width: 410px; height: 150px;display:none;"
     showmodal="true" allowresize="true" allowdrag="true" showclosebutton="true">
    <table style="width: 100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
            <td style="width:250px;">
                <input class="mini-htmlfile" name="Fdata" id="file1" style="width:250px;" />
            </td>
            <td style="width:60px;">
                <input type="button" value="上传" onclick="ajaxFileImport()" />
            </td>
            <td style="width:90px;">
                <a id="resultdownload" class="mini-button" enabled="false">结果下载</a>
            </td>
            <td></td>
        </tr>
        <tr><td>&nbsp;</td></tr>
        <tr><th style="padding-bottom: 5px; text-align: left;">模板下载</th></tr>
        <tr>
            <td>
                <a class="mini-button" onclick="window.location.href = '/Templet/导入用户模板.xls';">导入用户模板</a>
            </td>
            <td></td>
        </tr>
    </table>
</div>

<script>
    mini.parse()
    var staff_grid = mini.get("staff-datagrid");
    var importWindow = mini.get("import-window");

    staff_grid.load({
        pageIndex: 0,
        pageSize: 50,
        sortField: "Staff_ID",//排序字段必需要，不然没法分页
        sortOrder: "DESC",//排序字段必需要，不然没法分页
    }, function (data) {
        ajaxTips(data.text);
    }, function (data) {
    })

    function add() {
        mini.open({
            url: "@Url.Action("InsertIndex", "User", new { area = "Admin" })",
            title: "新增员工", width: 500, height: 350,
            onload: function () {
                debugger;
                var iframe = this.getIFrameEl();
                var data = { action: "new" };
                iframe.contentWindow.SetData(data);
            },
            ondestroy: function (action) {
                staff_grid.reload();
            }
        });
    }

    function edit() {
        var row = staff_grid.getSelected();
        if (row) {
            mini.open({
                url: "@Url.Action("EditIndex", "User", new { area = "Admin" })",
                title: "编辑员工", width: 500, height: 350,
                onload: function () {
                    var iframe = this.getIFrameEl();
                    var data = { action: "edit", ID: row.User_ID };
                    iframe.contentWindow.SetData(data);
                },
                ondestroy: function (action) {
                    staff_grid.reload();
                }
            });

        } else {
            alert("请选中一条记录");
        }

    }

    function addWeixinUser() {
        @*var row = staff_grid.getSelected();
        if (row) {
            var url = '@Url.Action("AddWeixinUser", "User", new { area = "Admin" })';
            var urlParms = { UserIDs: row.User_ID };
            debugger;
            doGet(url, urlParms);
        } else {
            alert("请选中一条记录");
        }*@


        var rows = staff_grid.getSelecteds();
        if (rows.length == 0) {
            if (confirm("确定增加选中记录的微信账号？")) {
                var ids = [];
                for (var i = 0, l = rows.length; i < l; i++) {
                    var r = rows[i];
                    ids.push(r.User_ID);
                }
                var id = ids.join(',');
                var url = '@Url.Action("AddWeixinUser", "User", new { area = "Admin" })';
                var urlParms = { UserIDs: id };
                debugger;
                doGet(url, urlParms, function (jdata) {
                    if (jdata.Code == '200') {
                        OrderGoods_grid.reload();
                    }
                });
            }
        } else {
            alert("请选中一条记录");
        }
    }

    //////////////////////////////////////////////
    //导入
    function importUser() {
        $('#resultdownload').removeAttr('onclick');
        mini.get("resultdownload").setEnabled(false);
        importWindow.show();
    }

    function ajaxFileImport() {

        staff_grid.loading("导入中，请稍后......");
        var inputFile = $("#file1 > input:file")[0];

        $.ajaxFileUpload({
            url: '@Url.Action("ImportUser", "User", new { area = "Admin" })',                 //用于文件上传的服务器端请求地址
            fileElementId: inputFile,               //文件上传域的ID
            data: null,          //附加的额外参数
            dataType: 'text',                   //返回值类型 一般设置为json
            success: function (data, status)    //服务器成功响应处理函数
            {
                debugger;
                ajaxTips(data, function (jdata) {
                    if (jdata.Code == "200") {
                        debugger;
                        $('#resultdownload').attr('href', jdata.Data);
                        mini.get("resultdownload").setEnabled(true);
                    }
                });
            },
            error: function (data, status, e)   //服务器响应失败处理函数
            {
                alert(e);
            },
            complete: function () {
                var jq = $("#file1 > input:file");
                jq.before(inputFile);
                jq.remove();
                staff_grid.reload();
                staff_grid.unmask();
            }
        });
    }



    //////////////////////////////////////////////////
    function onAddedVXUserRenderer(e) {
        if (e.value == 1) return "已添加";
        else return "未添加";
    }


</script>
