@{
    Layout = null;
}
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>报障系统</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <link href="~/Areas/Admin/Content/css/demo.css" rel="stylesheet" />

    <script src="~/Content/js/jquery-1.8.3.min.js"></script>
    <script src="~/Areas/Admin/Script/miniui/boot.js"></script>
    <script src="~/Areas/Admin/Content/js/public.js"></script>

    <style type="text/css">
        body {
            margin: 0;
            padding: 0;
            border: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .header {
            background: url(Areas/Admin/Content/images/header.gif) repeat-x 0 -1px;
        }
    </style>
</head>
<body>

    <!--Layout-->
    <div id="layout1" class="mini-layout" style="width:100%;height:100%;">
        <div class="header" region="north" height="70" showsplit="false" showheader="false">
            <h1 style="margin:0;padding:15px;cursor:default;font-family:微软雅黑,黑体,宋体;">报障系统 V1.0</h1>
            <div style="position:absolute;top:18px;right:10px;">
                <span class="mini-button mini-button-iconTop" iconcls="icon-user" plain="true">用户：@ViewBag.StaffName</span>
                <span class="mini-button mini-button-iconTop" iconcls="icon-user" plain="true" onclick="onShowChangeRoleWindow">角色：<label id="roleName">@ViewBag.RoleName</label></span>
                <a class="mini-button mini-button-iconTop" iconcls="icon-close" onclick="logout" plain="true">安全退出</a>
            </div>

        </div>
        @*<div title="south" region="south" showsplit="false" showheader="false" height="30">
                <div style="line-height:28px;text-align:center;cursor:default">Copyright © 佛山市宏达技术科技有限公司所有 </div>
            </div>*@
        <div title="center" region="center" style="border:0;" bodystyle="overflow:hidden;">
            <!--Splitter-->
            <div class="mini-splitter" style="width:100%;height:100%;" borderstyle="border:0;">
                <div size="180" maxsize="250" minsize="100" showcollapsebutton="true" style="border:0;">
                    <!--OutlookTree-->
                    <div id="leftTree" class="mini-outlooktree" onnodeclick="onNodeSelect"
                         idfield="ID" parentfield="ParentID" textfield="Title" iconfield="ImagUrl">
                    </div>

                </div>
                <div showcollapsebutton="false" style="border:0;">
                    <!--Tabs-->
                    <div id="mainTabs" class="mini-tabs" activeindex="0" style="width:100%;height:100%;"
                         plain="false" onactivechanged="onTabsActiveChanged">
                        <div title="首页">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="changeRole-Window" class="mini-window" title="切换角色" style="width:300px;display: none;"
         showmodal="true" allowresize="false" allowdrag="false" showclosebutton="true">
        <div id="form">
            <table>
                <tr>
                    <td>
                        <label>请选择角色：</label>
                    </td>
                    <td>
                        <input name="RoleID" id="RoleDDL" shownullitem="false" class="mini-combobox" textfield="Title" valuefield="ID" />
                    </td>
                </tr>
            </table>
        </div>
        <div class="mini-toolbar" style="text-align:center;padding-top:8px;padding-bottom:8px;" borderstyle="border:0;">
            <a class="mini-button" style="width:60px;" onclick="confirmChange()">确定</a>
            <span style="display:inline-block;width:25px;"></span>
            <a class="mini-button" style="width:60px;" onclick="closeChangeRoleWindow()">取消</a>
        </div>
    </div>

    <script type="text/javascript">
    mini.parse();

    var iframe = document.getElementById("mainframe");
    var tree = mini.get("leftTree");
    var changeRoleWindow = mini.get("changeRole-Window");

    $(function () {
        loadNav();
    })

    function loadNav() {
        var url = '@Url.Action("GetLeftTree", "Home", new { area = "Admin" })';

        doGet(url, null, function (jdata) {
            if (jdata.Code == '200') {
                tree.loadList(jdata.Data.JSNet);
            }
        })
    }

    function showTab(node) {
        var tabs = mini.get("mainTabs");

        var id = "tab$" + node.ID;
        var tab = tabs.getTab(id);
        if (!tab) {
            tab = {};
            tab._nodeid = node.ID;
            tab.name = id;
            tab.title = node.Title;
            tab.url = node.Url;
            tab.showCloseButton = true;

            tabs.addTab(tab);
        }
        tabs.activeTab(tab);
    }

    function onNodeSelect(e) {
        var node = e.node;
        var isLeaf = e.isLeaf;

        if (isLeaf) {
            showTab(node);
        }
    }

    function onTabsActiveChanged(e) {
        var tabs = e.sender;
        var tab = tabs.getActiveTab();
        if (tab && tab._nodeid) {

            var node = tree.getNode("'" + tab._nodeid + "'");
            if (node && !tree.isSelectedNode(node)) {
                tree.selectNode(node);
            }
        }
    }

    function logout() {
        var url = '@Url.Action("Logout", "Home", new { area = "Admin" })';
        doGet(url, null);
    }

    /////////////////////////////////////////////////////////////////////////////
    function onShowChangeRoleWindow() {

        var url = '@Url.Action("GetMyRolesDDL", "Role", new { area = "Admin" })';
        doGet(url, null, function (jdata) {
            if (jdata.Code == '200') {
                var roleDDL = new mini.get("RoleDDL");
                roleDDL.setData(jdata.Data);
                var rid = getCookie("RID");//这是加密了的数据，应该从后台获取
                debugger;
                roleDDL.setValue(rid);//选中当前使用中的角色
                changeRoleWindow.show();
            }
        })
    }

    function closeChangeRoleWindow() {
        changeRoleWindow.hide();
    }

    function confirmChange() {
        var form = new mini.Form("#form");
        var o = form.getData();
        var url = '@Url.Action("ChangeMyCurrentRole", "Role")';

        doGet(url, { RoleID: o.RoleID }, function (jdata) {
            if (jdata.Code == '200') {
                loadNav();
                closeAllTabs();
                var roleDDL = new mini.get("RoleDDL");
                $("#roleName").text(roleDDL.getText());
                changeRoleWindow.hide();
            }
        });
    }

    function closeAllTabs() {
        var tabs = mini.get("mainTabs");
        var but = tabs.getTab(0);
        tabs.removeAll(but);
    }
    </script>

</body>
</html>